"use strict";angular.module("db-monitor",["chayka-modals","chayka-utils"]).controller("db_monitor",["$scope","$timeout","modals","utils",function(a,b,c,d){angular.extend(a,{_:{dbMonitorModal:null},tree:{title:"Wordpress",items:[],time:0,total:0},parseQueries:function(b){b=b||window.Chayka.DB.queries||[];for(var c=[],e=a.tree,f=[],g=0,h=b.length;h>g;g++){var i=b[g],j=i[0];j=j.replace(/\s+(FROM|LEFT|RIGHT|INNER|OUTER|CROSS|WHERE|ORDER|GROUP|HAVING|LIMIT|OR)\b/g,"\n$1"),j=j.replace(/\s+(AND)\b/g,"\n  $1");var k=i[1],l=i[2].split(", "),m={sql:j,time:k,path:l};c.push(m);for(var n=null,o=0,p=l.length;p>o;o++){var q=l[o],r=o?d.getItem(f,o-1):e;n=d.getItem(f,o),n&&n.title===q||(n={title:q,items:[],time:0,total:0},r.items.push(n),f[o]=n,f=f.slice(0,o+1))}for(n.items.push({sql:j,time:k}),o=l.length-1;o>=0;o--)n=f[o],n.time+=k,n.total++;e.time+=k,e.total++}console.dir({tree:e})},showMonitor:function(){a._.dbMonitorModal.show(),window.localStorage.openDbMonitor="1"},hideMonitor:function(){window.localStorage.openDbMonitor=""}}),a.parseQueries(),window.localStorage.openDbMonitor&&b(a.showMonitor,300),d.ensure("Chayka.DB",{showMonitor:function(){a.showMonitor(),a.$apply()}})}]).directive("dbMonitorNode",["utils",function(a){return{restrict:"AE",scope:{node:"=dbMonitorNode"},replace:!0,template:'<div class="node" data-ng-class="{open: !!unfold, sql: !!node.sql, func: !!node.title}" data-ng-init="unfold=($parent && !!$parent.unfold && $parent.node.items.length===1)">   <div class="item" data-ng-click="unfoldNode()" data-ng-style="{color: getColor()}">       <span class="time">{{node.time | number : 5 }}</span>        <span class="title">{{node.title}}</span>        <span class="sql">{{node.sql}}</span>        <span class="total">{{node.total || ""}}</span>   </div>   <div class="items">       <div data-ng-repeat="item in getItems()" data-db-monitor-node="item" >       </div>   </div></div>',controller:["$scope","$element",function(a,b){angular.extend(a,{unfoldNode:function(){a.unfold=!a.unfold,a.unfold&&a.$broadcast("dbMonitor.nodeUnfolded")},getColor:function(){return a.$parent.node&&"hsl(240, "+Math.round(100*a.node.time/a.$parent.node.time)+"%, 50%)"||"black"},getItems:function(){return a.unfold&&a.node.items||[]}}),a.$on("dbMonitor.nodeUnfolded",function(){a.node&&a.node.items&&1===a.node.items.length&&!a.unfold&&a.unfoldNode()}),console.dir({scope:a})}],compile:function(b){return a.recursiveDirectiveCompile(b)},link:function(a,b){}}}]);